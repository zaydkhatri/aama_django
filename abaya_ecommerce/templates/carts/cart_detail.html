{% extends 'base.html' %}
{% load static %}

{% block title %}Your Shopping Cart | Abaya Elegance{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<div class="breadcrumb-section">
    <div class="container">
        <div class="row">
            <div class="col-12 text-center">
                <h1 class="breadcrumb-title">Shopping Cart</h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb justify-content-center">
                        <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Shopping Cart</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Cart Section -->
<section class="cart-section section-padding">
    <div class="container">
        {% if cart.items.exists %}
        <div class="row">
            <!-- Cart Items -->
            <div class="col-lg-8 mb-5 mb-lg-0">
                <div class="cart-table">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th class="text-center">Price</th>
                                <th class="text-center">Quantity</th>
                                <th class="text-center">Total</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in cart.items.all %}
                            <tr id="cart-item-{{ item.id }}" class="cart-item">
                                <td>
                                    <div class="cart-product">
                                        <div class="cart-product-img">
                                            {% if item.product.default_image %}
                                            <img src="{{ item.product.default_image.url }}" alt="{{ item.product.name }}">
                                            {% else %}
                                            <img src="{% static 'images/product-placeholder.jpg' %}" alt="{{ item.product.name }}">
                                            {% endif %}
                                        </div>
                                        <div>
                                            <h5 class="cart-product-name">
                                                <a href="{% url 'product_detail' item.product.slug %}">{{ item.product.name }}</a>
                                            </h5>
                                            <div class="cart-product-info">
                                                SKU: {{ item.product.sku }}
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-center">
                                    {{ item.product.get_price_display }}
                                </td>
                                <td class="text-center">
                                    <form action="{% url 'update_cart' %}" method="post" class="cart-update-form">
                                        {% csrf_token %}
                                        <input type="hidden" name="item_id" value="{{ item.id }}">
                                        <div class="quantity-input mx-auto" style="width: 100px;">
                                            <button type="button" class="quantity-btn minus">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                            <input type="number" name="quantity" value="{{ item.quantity }}" min="1" max="{{ item.product.quantity }}" class="cart-quantity">
                                            <button type="button" class="quantity-btn plus">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </form>
                                </td>
                                <td class="text-center cart-item-total-{{ item.id }}">
                                    {% if item.get_total_price_display %}
                                        {{ item.get_total_price_display }}
                                    {% else %}
                                        {{ item.product.get_price_display }}
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <form action="{% url 'remove_from_cart' %}" method="post" class="d-inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="item_id" value="{{ item.id }}">
                                        <button type="submit" class="cart-remove" title="Remove item">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="cart-buttons">
                    <a href="{% url 'product_list' %}" class="btn btn-outline-primary">
                        <i class="fas fa-long-arrow-alt-left me-2"></i>Continue Shopping
                    </a>
                    
                    <form action="{% url 'clear_cart' %}" method="post" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-danger" onclick="return confirm('Are you sure you want to clear your cart?')">
                            <i class="fas fa-trash me-2"></i>Clear Cart
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Cart Summary -->
            <div class="col-lg-4">
                <div class="cart-summary">
                    <h3 class="summary-title">Order Summary</h3>
                    
                    <div class="summary-item">
                        <div class="summary-key">Subtotal</div>
                        <div class="summary-value cart-subtotal">
                            {% if cart.get_subtotal_display %}
                                {{ cart.get_subtotal_display }}
                            {% else %}
                                {{ cart.get_total_price }}
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="summary-item">
                        <div class="summary-key">Shipping</div>
                        <div class="summary-value cart-shipping">
                            To be calculated at checkout
                        </div>
                    </div>
                    
                    {% if cart.discount_amount and cart.discount_amount > 0 %}
                    <div class="summary-item">
                        <div class="summary-key">Discount</div>
                        <div class="summary-value cart-discount text-success">
                            {% if cart.discount_display %}
                                {{ cart.discount_display }}
                            {% else %}
                                -{{ cart.discount_amount }}
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="summary-item summary-total">
                        <div class="summary-key">Total</div>
                        <div class="summary-value cart-total">
                            {% if cart.get_total_display %}
                                {{ cart.get_total_display }}
                            {% else %}
                                {{ cart.get_total_price }}
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="coupon-section mt-4">
                        <form action="{% url 'apply_coupon' %}" method="post" id="coupon-form">
                            {% csrf_token %}
                            <div class="input-group">
                                <input type="text" name="code" class="form-control" placeholder="Coupon code">
                                <button type="submit" class="btn btn-primary">Apply</button>
                            </div>
                        </form>
                    </div>
                    
                    <a href="{% url 'checkout' %}" class="btn btn-primary w-100 mt-4">
                        Proceed to Checkout <i class="fas fa-long-arrow-alt-right ms-2"></i>
                    </a>
                </div>
            </div>
        </div>
        {% else %}
        <div class="text-center py-5">
            <div class="mb-4">
                <i class="fas fa-shopping-cart fa-4x text-muted"></i>
            </div>
            <h3>Your cart is empty</h3>
            <p>You have no items in your shopping cart.</p>
            <a href="{% url 'product_list' %}" class="btn btn-primary mt-3">
                <i class="fas fa-long-arrow-alt-left me-2"></i>Continue Shopping
            </a>
        </div>
        {% endif %}
    </div>
</section>

{% if not cart.items.exists %}
<!-- Empty Cart Recommendations -->
<section class="section-padding bg-light">
    <div class="container">
        <div class="section-title">
            <h2>Recommended Products</h2>
            <p>You might be interested in these products</p>
        </div>
        
        <div class="row">
            {% for product in recommended_products|slice:":4" %}
            <div class="col-lg-3 col-md-4 col-sm-6">
                <div class="product-card">
                    <div class="product-image">
                        {% if product.is_in_stock %}
                        {% if product.sale_price %}
                        <div class="product-badges">
                            <span class="product-badge badge-sale">
                                -{{ product.get_discount_percentage }}%
                            </span>
                        </div>
                        {% endif %}
                        {% else %}
                        <div class="product-badges">
                            <span class="product-badge badge-out">Out of Stock</span>
                        </div>
                        {% endif %}
                        
                        <div class="product-actions">
                            <a href="#" class="action-btn add-to-wishlist" data-url="{% url 'add_to_wishlist' %}" data-product-id="{{ product.id }}" data-bs-toggle="tooltip" title="Add to Wishlist">
                                <i class="far fa-heart"></i>
                            </a>
                            <a href="{% url 'product_detail' product.slug %}" class="action-btn" data-bs-toggle="tooltip" title="Quick View">
                                <i class="far fa-eye"></i>
                            </a>
                        </div>
                        
                        {% if product.default_image %}
                        <img src="{{ product.default_image.url }}" alt="{{ product.name }}">
                        {% else %}
                        <img src="{% static 'images/product-placeholder.jpg' %}" alt="{{ product.name }}">
                        {% endif %}
                    </div>
                    
                    <div class="product-body">
                        <div class="product-category">
                            {% for category in product.categories.all|slice:":1" %}
                            {{ category.name }}
                            {% endfor %}
                        </div>
                        <h3 class="product-title">
                            <a href="{% url 'product_detail' product.slug %}">{{ product.name }}</a>
                        </h3>
                        <div class="product-price">
                            {% with price_display=product.get_price_display regular_price=product.get_regular_price_display %}
                                <span class="current-price">{{ price_display }}</span>
                                {% if product.sale_price %}
                                <span class="old-price">{{ regular_price }}</span>
                                {% endif %}
                            {% endwith %}
                        </div>
                        
                        <form action="{% url 'add_to_cart' %}" method="post" class="add-to-cart-form">
                            {% csrf_token %}
                            <input type="hidden" name="product_id" value="{{ product.id }}">
                            <input type="hidden" name="quantity" value="1">
                            <button type="submit" class="btn btn-primary add-to-cart" {% if not product.is_in_stock %}disabled{% endif %}>
                                <i class="fas fa-shopping-cart me-2"></i>Add to Cart
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12 text-center">
                <p>No recommended products at this time.</p>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- You May Also Like -->
<section class="section-padding{% if cart.items.exists %} bg-light{% endif %}">
    <div class="container">
        <div class="section-title">
            <h2>You May Also Like</h2>
            <p>Explore more of our collection</p>
        </div>
        
        <div class="swiper product-slider">
            <div class="swiper-wrapper">
                {% for product in trending_products|slice:":8" %}
                <div class="swiper-slide">
                    <div class="product-card">
                        <div class="product-image">
                            {% if product.is_in_stock %}
                            {% if product.sale_price %}
                            <div class="product-badges">
                                <span class="product-badge badge-sale">
                                    -{{ product.get_discount_percentage }}%
                                </span>
                            </div>
                            {% endif %}
                            {% else %}
                            <div class="product-badges">
                                <span class="product-badge badge-out">Out of Stock</span>
                            </div>
                            {% endif %}
                            
                            <div class="product-actions">
                                <a href="#" class="action-btn add-to-wishlist" data-url="{% url 'add_to_wishlist' %}" data-product-id="{{ product.id }}" data-bs-toggle="tooltip" title="Add to Wishlist">
                                    <i class="far fa-heart"></i>
                                </a>
                                <a href="{% url 'product_detail' product.slug %}" class="action-btn" data-bs-toggle="tooltip" title="Quick View">
                                    <i class="far fa-eye"></i>
                                </a>
                            </div>
                            
                            {% if product.default_image %}
                            <img src="{{ product.default_image.url }}" alt="{{ product.name }}">
                            {% else %}
                            <img src="{% static 'images/product-placeholder.jpg' %}" alt="{{ product.name }}">
                            {% endif %}
                        </div>
                        
                        <div class="product-body">
                            <div class="product-category">
                                {% for category in product.categories.all|slice:":1" %}
                                {{ category.name }}
                                {% endfor %}
                            </div>
                            <h3 class="product-title">
                                <a href="{% url 'product_detail' product.slug %}">{{ product.name }}</a>
                            </h3>
                            <div class="product-price">
                                {% with price_display=product.get_price_display regular_price=product.get_regular_price_display %}
                                    <span class="current-price">{{ price_display }}</span>
                                    {% if product.sale_price %}
                                    <span class="old-price">{{ regular_price }}</span>
                                    {% endif %}
                                {% endwith %}
                            </div>
                            
                            <form action="{% url 'add_to_cart' %}" method="post" class="add-to-cart-form">
                                {% csrf_token %}
                                <input type="hidden" name="product_id" value="{{ product.id }}">
                                <input type="hidden" name="quantity" value="1">
                                <button type="submit" class="btn btn-primary add-to-cart" {% if not product.is_in_stock %}disabled{% endif %}>
                                    <i class="fas fa-shopping-cart me-2"></i>Add to Cart
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12 text-center">
                    <p>No trending products at this time.</p>
                </div>
                {% endfor %}
            </div>
            
            <div class="swiper-pagination"></div>
        </div>
    </div>
</section>

<!-- Toast Container for Notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3"></div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Flag to prevent multiple simultaneous updates
        let isUpdating = false;
        
        // Track the last update timestamp to prevent rapid clicks
        let lastUpdateTime = 0;
        
        // Quantity buttons functionality
        $('.quantity-btn.minus').on('click', function(e) {
            e.preventDefault(); // Prevent default behavior
            if (isUpdating) return; // Don't allow if an update is in progress
            
            var input = $(this).siblings('input');
            var value = parseInt(input.val());
            if (value > 1) {
                input.val(value - 1);
                // Mark the input as programmatically changed
                input.data('programmatic-change', true);
                // Submit the form directly without triggering change event
                updateCart($(this).closest('form'));
            }
        });
        
        $('.quantity-btn.plus').on('click', function(e) {
            e.preventDefault(); // Prevent default behavior
            if (isUpdating) return; // Don't allow if an update is in progress
            
            var input = $(this).siblings('input');
            var max = parseInt(input.attr('max'));
            var value = parseInt(input.val());
            if (value < max) {
                input.val(value + 1);
                // Mark the input as programmatically changed
                input.data('programmatic-change', true);
                // Submit the form directly without triggering change event
                updateCart($(this).closest('form'));
            }
        });
        
        // Manual input handling - only trigger when the user manually changes the input
        $('.cart-quantity').on('change', function(e) {
            // Check if this was triggered programmatically by our buttons
            if ($(this).data('programmatic-change')) {
                $(this).data('programmatic-change', false);
                return; // Don't process the change event
            }
            
            // This is a manual change, so update the cart
            updateCart($(this).closest('form'));
        });
        
        // Debounced cart update function
        function updateCart(form) {
            // Prevent multiple simultaneous updates
            if (isUpdating) return;
            
            // Implement a cooldown period (500ms) to prevent rapid updates
            const now = Date.now();
            if (now - lastUpdateTime < 500) return;
            
            lastUpdateTime = now;
            isUpdating = true;
            
            var url = form.attr('action');
            var data = form.serialize();
            
            $.ajax({
                type: "POST",
                url: url,
                data: data,
                success: function(response) {
                    isUpdating = false;
                    
                    if (response.status === 'success') {
                        // Update item total
                        var itemId = form.find('input[name="item_id"]').val();
                        
                        if (response.item_total_formatted) {
                            // Use formatted total if available
                            $('.cart-item-total-' + itemId).text(response.item_total_formatted);
                        } else {
                            // Fallback to raw value
                            var total = response.item_total.toFixed(2);
                            $('.cart-item-total-' + itemId).text('$' + total);
                        }
                        
                        // Update cart totals
                        if (response.cart_subtotal_formatted) {
                            $('.cart-subtotal').text(response.cart_subtotal_formatted);
                        }
                        
                        if (response.cart_total_formatted) {
                            $('.cart-total').text(response.cart_total_formatted);
                        } else {
                            $('.cart-total').text('$' + response.cart_total.toFixed(2));
                        }
                        
                        // Update cart header count if it exists
                        if (response.cart_count) {
                            $('.header-cart-count').text(response.cart_count);
                        }
                        
                        // Show success message
                        showNotification(response.message, 'success');
                    } else if (response.status === 'info') {
                        // Show info message
                        showNotification(response.message, 'info');
                    } else {
                        // Show error message
                        showNotification(response.message, 'danger');
                    }
                },
                error: function(xhr) {
                    isUpdating = false;
                    
                    // Parse error response if possible
                    try {
                        var errorData = JSON.parse(xhr.responseText);
                        showNotification(errorData.message || 'An error occurred. Please try again.', 'danger');
                    } catch (e) {
                        showNotification('An error occurred. Please try again.', 'danger');
                    }
                }
            });
        }
        
        // Function to show notification toast
        function showNotification(message, type) {
            var toast = $('<div class="toast align-items-center text-white bg-' + type + ' border-0" role="alert" aria-live="assertive" aria-atomic="true">');
            toast.html('<div class="d-flex"><div class="toast-body">' + message + '</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>');
            
            $('.toast-container').append(toast);
            
            var toastElement = new bootstrap.Toast(toast, {
                autohide: true,
                delay: 5000
            });
            
            toastElement.show();
            
            // Remove toast after hidden
            toast.on('hidden.bs.toast', function () {
                $(this).remove();
            });
        }
    });
</script>
{% endblock %}